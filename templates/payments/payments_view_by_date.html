{% extends "base.html" %}

{% block title %}Payments - {{ date.strftime('%d-%m-%Y') }}{% endblock %}

{% block content %}

<div class="container mt-4">

    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <a href="{{ url_for('payments.list_payment_dates') }}" class="btn btn-secondary">â¬… Back</a>
        <h3 class="fw-bold text-primary m-0">Payments on {{ date.strftime('%d-%m-%Y') }}</h3>
        <button onclick="window.print()" class="btn btn-success">ðŸ–¨ Print</button>
    </div>


    <!-- ============================
         PAYMENT TABLE MACRO
         ============================ -->

    {% macro payments_table(payments, title, total) %}
    <div class="card my-4 shadow-sm">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">{{ title }}</h5>
        </div>

        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-striped mb-0">
                    <thead class="table-light text-center">
                        <tr>
                            <th>S. No</th>
                            <th>Weaver Name</th>
                            <th>Bank Holder Name</th>
                            <th>Account Number</th>
                            <th>IFSC Code</th>
                            <th>Account Type</th>
                            <th class="text-end">Amount</th>
                        </tr>
                    </thead>

                    <tbody>
                        {% if payments|length > 0 %}
                            {% for p in payments %}
                            <tr>
                                <td class="text-center">{{ loop.index }}</td>

                                <td>{{ p.weaver.weavername if p.weaver else "-" }}</td>

                                <td>{{ p.name_in_bank or (p.weaver.name_in_bank if p.weaver else "-") }}</td>
                                <td>{{ p.account_number or (p.weaver.account_number if p.weaver else "-") }}</td>
                                <td>{{ p.ifsc_code or (p.weaver.ifsc_code if p.weaver else "-") }}</td>

                                <td class="text-center">
                                    {{ p.account_type or (p.weaver.account_type if p.weaver else "-") }}
                                </td>

                                <td class="text-end fw-bold text-success">
                                    {{ "%.2f"|format(p.amount or 0) }}
                                </td>
                            </tr>
                            {% endfor %}
                        {% else %}
                            <tr>
                                <td colspan="7" class="text-center py-3 text-muted">No payments</td>
                            </tr>
                        {% endif %}
                    </tbody>

                    <tfoot>
                        <tr>
                            <th colspan="6" class="text-end">Total</th>
                            <th class="text-end fw-bold">{{ "%.2f"|format(total or 0) }}</th>
                        </tr>
                    </tfoot>

                </table>
            </div>
        </div>
    </div>
    {% endmacro %}


    <!-- ============================
         ROLE BASED TABLE DISPLAY
         ============================ -->

    {% if user_role == 'handloom_factory' %}
        {{ payments_table(handloom_payments, "Handloom Payments", totals.handloom) }}
    {% endif %}

    {% if user_role == 'powerloom_factory' %}
        {{ payments_table(powerloom_payments, "Powerloom Payments", totals.powerloom) }}
    {% endif %}

    {% if user_role == 'outside_handloom' %}
        {{ payments_table(outside_handloom_payments, "Outside Handloom Payments", totals.outside_handloom) }}
    {% endif %}

    {% if user_role == 'outside_powerloom' %}
        {{ payments_table(outside_powerloom_payments, "Outside Powerloom Payments", totals.outside_powerloom) }}
    {% endif %}

    {% if user_role == 'owner' %}
        {{ payments_table(handloom_payments, "Handloom Payments", totals.handloom) }}
        {{ payments_table(powerloom_payments, "Powerloom Payments", totals.powerloom) }}
        {{ payments_table(outside_handloom_payments, "Outside Handloom Payments", totals.outside_handloom) }}
        {{ payments_table(outside_powerloom_payments, "Outside Powerloom Payments", totals.outside_powerloom) }}

        <div class="text-end mt-2">
            <h4>Grand Total:
                <strong class="text-success">
                    {{ "%.2f"|format(totals.grand_total) }}
                </strong>
            </h4>
        </div>
    {% endif %}

</div>


<!-- PRINTING STYLE -->
<style>
@media print {
    body * { visibility: hidden !important; }
    .container, .container * { visibility: visible !important; }
    .container {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
    }
    a, button { display: none !important; }
    th, td {
        border: 1px solid #000 !important;
        color: #000 !important;
    }
    table { border-collapse: collapse !important; }
}
</style>

{% endblock %}
