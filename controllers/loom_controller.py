from flask import (
    Blueprint, render_template, request, redirect,
    url_for, flash, current_app, send_file
)
from flask_login import login_required, current_user
from werkzeug.utils import secure_filename
from models.loom import Warp
from models.loom import Weft

from models.loom import Loom, Warp, Weft, WarpColor




import os
import io
from datetime import datetime
from sqlalchemy import func

from models.loom import Loom, SareeEntry
from models.weaver import Weaver
from app import db

loom_bp = Blueprint("loom", __name__, url_prefix="/loom")

# -------------------------------
# Color Dictionary (Centralized)
# -------------------------------
ALL_COLORS = {
    '1M': '#dedd9a',
    '2M': '#dbd388',
    '3M': '#beaa63',
    '4M': '#c1893c',
    '5M': '#ae6942',
    '6M': '#c69057',
    '7M': '#c68697',
    '8M': '#6f3b47',
    '9M': '#7b4140',
    '10M': '#724037',
    '11M': '#e48ca5',
    '12M': '#f1a0af',
    '13M': '#f696bb',
    '14M': '#885172',
    '15M': '#705983',
    '16M': '#775b4d',
    '17M': '#867a54',
    '18M': '#937249',
    '19M': '#9c9277',
    '20M': '#896648',
    '21M': '#74624e',
    '22M': '#bcaf78',
    '23M': '#524d49',
    '24M': '#9a8d6a',
    '25M': '#b79b59',
    '26M': '#65ab6f',
    '27M': '#498a54',
    '28M': '#567249',
    '29M': '#556439',
    '30M': '#276250',
    '31M': '#3d9998',
    '32M': '#4cadc0',
    '33M': '#17929e',
    '34M': '#0b839f',
    '35M': '#11686f',
    '36M': '#588daf',
    '37M': '#6191c1',
    '38M': '#68659f',
    '39M': '#7b8587',
    '40M': '#595d5c',
    '41M': '#eee656',
    '42M': '#f2e602',
    '43M': '#ecbe08',
    '44M': '#d29b1d',
    '45M': '#b08c2c',
    '46M': '#f0af1a',
    '47M': '#e8a501',
    '48M': '#bf6318',
    '49M': '#a94e1e',
    '50M': '#ce7741',
    '51M': '#de598f',
    '52M': '#eb6296',
    '53M': '#b33574',
    '54M': '#fc5da5',
    '55M': '#fc8fd2',
    '56M': '#df3fa7',
    '57M': '#a02a76',
    '58M': '#b1556c',
    '59M': '#843844',
    '60M': '#6e3138',
    '61M': '#e17139',
    '62M': '#f3753e',
    '63M': '#d44c40',
    '64M': '#be4a45',
    '65M': '#812439',
    '66M': '#b03439',
    '67M': '#9a303a',
    '68M': '#6b3140',
    '69M': '#793640',
    '70M': '#77303b',
    '71M': '#703254',
    '72M': '#8e3b69',
    '73M': '#623459',
    '74M': '#5c3562',
    '75M': '#5d4486',
    '76M': '#383258',
    '77M': '#32326b',
    '78M': '#3b429a',
    '79M': '#383963',
    '80M': '#34385b',
    '81M': '#637d3c',
    '82M': '#648a3f',
    '83M': '#2f542b',
    '84M': '#2e4824',
    '85M': '#1d472d',
    '86M': '#1d452d',
    '87M': '#1c4633',
    '88M': '#19342f',
    '89M': '#193830',
    '90M': '#193732',
    '91M': '#194041',
    '92M': '#143638',
    '93M': '#0f464d',
    '94M': '#163530',
    '95M': '#1b322c',
    '96M': '#2c372c',
    '97M': '#2e3a24',
    '98M': '#515c1f',
    '99M': '#2a302c',
    '100M': '#343629',
    '101M': '#334e3d',
    '102M': '#213538',
    '103M': '#203339',
    '104M': '#20372f',
    '105M': '#183032',
    '106M': '#0e3449',
    '107M': '#173341',
    '108M': '#154364',
    '109M': '#223c56',
    '110M': '#20425d',
    '111M': '#225281',
    '112M': '#213770',
    '113M': '#1f344f',
    '114M': '#22397d',
    '115M': '#1a2c5e',
    '116M': '#242c51',
    '117M': '#262e42',
    '118M': '#252f62',
    '119M': '#283047',
    '120M': '#282c38',
    '121M': '#d7b538',
    '122M': '#996a39',
    '123M': '#7d502f',
    '124M': '#a26019',
    '125M': '#84604f',
    '126M': '#894c2d',
    '127M': '#97683e',
    '128M': '#a16742',
    '129M': '#694d41',
    '130M': '#795836',
    '131M': '#60632e',
    '132M': '#6a7033',
    '133M': '#857e37',
    '134M': '#4e391f',
    '135M': '#655232',
    '136M': '#482b25',
    '137M': '#704f40',
    '138M': '#5d3b2f',
    '139M': '#403434',
    '140M': '#403b35',
    '141M': '#b26150',
    '142M': '#6a4743',
    '143M': '#814231',
    '144M': '#9b593a',
    '145M': '#4d3437',
    '146M': '#62232c',
    '147M': '#49232e',
    '148M': '#612b39',
    '149M': '#7c303a',
    '150M': '#3f3035',
    '151M': '#403a45',
    '152M': '#3f313b',
    '153M': '#474047',
    '154M': '#493439',
    '155M': '#3b363c',
    '156M': '#343138',
    '157M': '#2f374c',
    '158M': '#2f3847',
    '159M': '#2e3136',
    '160M': '#303538',
    '161M': '#c1734b',
    '162M': '#6c3f44',
    '163M': '#857081',
    '164M': '#675042',
    '165M': '#beb46d',
    '166M': '#495e4b',
    '167M': '#244741',
    '168M': '#4a656c',
    '169M': '#a99452',
    '170M': '#795e31',
    '171M': '#807e4d',
    '172M': '#575b36',
    '173M': '#898153',
    '174M': '#285157',
    '175M': '#2d6250',
    '176M': '#324a4a',
    '177M': '#1b6b7b',
    '178M': '#196269',
    '179M': '#864843',
    '180M': '#7c5840',
    '181M': '#715d52',
    '182M': '#7a4346',
    '183M': '#634749',
    '184M': '#833b61',
    '185M': '#9a5f6e',
    '186M': '#723f50',
    '187M': '#6f4052',
    '188M': '#755272',
    '189M': '#876a80',
    '190M': '#503d5d',
    '191M': '#7b4f73',
    '192M': '#6060a6',
    '193M': '#465493',
    '194M': '#a97754',
    '195M': '#6a4e4b',
    '196M': '#685038',
    '197M': '#574d4b',
    '198M': '#503d37',
    '199M': '#7e6b4b',
    '200M': '#7f6c4b',
    '201M': '#baa266',
    '202M': '#878765',
    '203M': '#7f8966',
    '204M': '#79796d',
    '205M': '#635961',
    '206M': '#364a49',
    '207M': '#4e4d48',
    '208M': '#3a4747',
    '209M': '#95a345',
    '210M': '#457687',
    '211M': '#a98f8e',
    '212M': '#936465',
    '213M': '#8593b0',
    '214M': '#d0b58a',
    '215M': '#989a85',
    '216M': '#565749',
    '217M': '#a87c19',
    '218M': '#a85f32',
    '219M': '#e1477c',
    '220M': '#493238',
    '221M': '#643640',
    '222M': '#482732',
    '223M': '#3c2642',
    '224M': '#282959',
    '225M': '#65882d',
    '226M': '#0a2c20',
    '227M': '#034432',
    '228M': '#42542e',
    '229M': '#26373f',
    '230M': '#283f4d',
    '231M': '#254365',
    '232M': '#262f40',
    '233M': '#9c7a4b',
    '234M': '#a28633',
    '235M': '#5d5833',
    '236M': '#583e2d',
    '237M': '#524232',
    '238M': '#482e39',
    '239M': '#423638',
    '240M': '#353537',
    '241M': '#bb7132',
    '242M': '#a5680f',
    '243M': '#8c3f23',
    '244M': '#732118',
    '245M': '#21204a',
    '246M': '#14334f',
    '247M': '#102f4b',
    '248M': '#552353',
    '249M': '#372325',
    '250M': '#2b4426',
    '251M': '#266864',
    '252M': '#135941',
    '253M': '#c54659',
    '254M': '#bc4042',
    '255M': '#e06f68',
    '256M': '#bf4c5b',
    '257M': '#8e5314',
    '258M': '#713624',
    '259M': '#503f29',
    '260M': '#60321b',
    '261M': '#dda23b',
    '262M': '#654e2e',
    '263M': '#b1975d',
    '264M': '#b5a478',
    '265M': '#8e794a',
    '266M': '#644c23',
    '267M': '#5a4727',
    '268M': '#b74239',
    '269M': '#9d3f3f',
    '270M': '#4c3b31',
    '271M': '#5e2f3b',
    '272M': '#6b294f',
    '273M': '#0d4c4a',
    '274M': '#1b296c',
    '275M': '#123740',
    '276M': '#1f2933',
    '277M': '#3f5429',
    '278M': '#223742',
    '279M': '#2c3240',
    '280M': '#7d3e67',
    '281M': '#785e43',
    '282M': '#efab64',
    '283M': '#38614f',
    '284M': '#b5a58c',
    '285M': '#90661c',
    '286M': '#ab7f1e',
    '287M': '#397340',
    '288M': '#52643a',
    '289M': '#6b4861',
    '290M': '#716152',
    '291M': '#7b593c',
    '292M': '#ce804f',
    '293M': '#9eb95c',
    '294M': '#7a8694',
    '295M': '#615d51',
    '296M': '#424b6c',
    '297M': '#838b62',
    '298M': '#4e5c5d',
    '299M': '#615792',
    '300M': '#844c4d',
    '301M': '#f2b953',
    '302M': '#cd6274',
    '303M': '#4e6d6d',
    '304M': '#2f8ad0',
    '305M': '#fb8187',
    '306M': '#018cc5',
    '307M': '#fe77a2',
    '308M': '#61ba69',
    '309M': '#97649f',
    '310M': '#4c55a4',
    '311M': '#6a4d48',
    '312M': '#4b71c6',
    '313M': '#77525a',
    '314M': '#586286',
    '315M': '#7d435b',
    '316M': '#6a4b4d',
    '317M': '#923675',
    '318M': '#5e5151',
    '319M': '#655c5d',
    '320M': '#afa790',
    '321M': '#c4a935',
    '322M': '#9e7e2d',
    '323M': '#775609',
    '324M': '#7c3f10',
    '325M': '#702d1c',
    '326M': '#533d34',
    '327M': '#42342b',
    '328M': '#272622',
    '329M': '#a28f19',
    '330M': '#b5932f',
    '331M': '#c3a020',
    '332M': '#c78642',
    '333M': '#843c29',
    '334M': '#70513d',
    '335M': '#654b3c',
    '336M': '#3b372c',
    '337M': '#7c7838',
    '338M': '#3c2f26',
    '339M': '#886f2d',
    '340M': '#4c3e23',
    '341M': '#3a2627',
    '342M': '#655139',
    '343M': '#463d2d',
    '344M': '#2f2b2c',
    '345M': '#9a984d',
    '346M': '#5f4f39',
    '347M': '#6f5911',
    '348M': '#786739',
    '349M': '#634d40',
    '350M': '#745e41',
    '351M': '#5d5338',
    '352M': '#494440',
    '353M': '#9b634a',
    '354M': '#63322b',
    '355M': '#4b2b2e',
    '356M': '#4a1728',
    '357M': '#661a20',
    '358M': '#532025',
    '359M': '#4a2934',
    '360M': '#433034',
    '361M': '#a1714d',
    '362M': '#a1685a',
    '363M': '#805a57',
    '364M': '#793953',
    '365M': '#a43e3c',
    '366M': '#87373a',
    '367M': '#6b354d',
    '368M': '#65464b',
    '369M': '#3d3739',
    '370M': '#343339',
    '371M': '#3a3436',
    '372M': '#382e2f',
    '373M': '#432834',
    '374M': '#312b2f',
    '375M': '#373037',
    '376M': '#4b2f2c',
    '377M': '#786664',
    '378M': '#4b4b4d',
    '379M': '#4b4b4d',
    '380M': '#625453',
    '381M': '#6a4851',
    '382M': '#4c4648',
    '383M': '#4a3e4c',
    '384M': '#653a39',
    '385M': '#575839',
    '386M': '#423a2d',
    '387M': '#29321d',
    '388M': '#26372d',
    '389M': '#2b382d',
    '390M': '#3c3d2b',
    '391M': '#4c513a',
    '392M': '#3b3c2a',
    '393M': '#817b49',
    '394M': '#51503b',
    '395M': '#3d4826',
    '396M': '#445c45',
    '397M': '#333832',
    '398M': '#4f4835',
    '399M': '#5c6342',
    '400M': '#505038',
    '401M': '#27413e',
    '402M': '#474f44',
    '403M': '#083e5a',
    '404M': '#003942',
    '405M': '#02447a',
    '406M': '#0e4057',
    '407M': '#193867',
    '408M': '#2c3463',
    '409M': '#264d4a',
    '410M': '#63695d',
    '411M': '#014972',
    '412M': '#024e5b',
    '413M': '#005e8a',
    '414M': '#005c6f',
    '415M': '#265992',
    '416M': '#32468b',
    '417M': '#026962',
    '418M': '#3c5b53',
    '419M': '#23506f',
    '420M': '#37455f',
    '421M': '#27413e',
    '422M': '#29333d',
    '423M': '#31353d',
    '424M': '#403f44',
    '425M': '#089282',
    '426M': '#577b6f',
    '427M': '#3d6e8c',
    '428M': '#3d6e8c',
    '429M': '#33524d',
    '430M': '#3a4450',
    '431M': '#585c65',
    '432M': '#615a62',
    '433M': '#9c3b68',
    '434M': '#8a2459',
    '435M': '#612a54',
    '436M': '#3e2646',
    '437M': '#352f75',
    '438M': '#263784',
    '439M': '#364152',
    '440M': '#393d46',
    '441M': '#ab4d71',
    '442M': '#ae4182',
    '443M': '#955189',
    '444M': '#8c437b',
    '445M': '#534c9a',
    '446M': '#5469b8',
    '447M': '#485868',
    '448M': '#414b57',
    '449M': '#bbb046',
    '450M': '#a6924d',
    '451M': '#875926',
    '452M': '#6f5c3b',
    '453M': '#544b2e',
    '454M': '#67473c',
    '455M': '#553d33',
    '456M': '#352b22',
    '457M': '#afa862',
    '458M': '#b4ab74',
    '459M': '#a27b4a',
    '460M': '#968665',
    '461M': '#685f40',
    '462M': '#7a5a4d',
    '463M': '#71564e',
    '464M': '#564d40',
    '465M': '#766f52',
    '466M': '#5e6048',
    '467M': '#544947',
    '468M': '#5a4942',
    '469M': '#453e46',
    '470M': '#292631',
    '471M': '#422d32',
    '472M': '#433f34',
    '473M': '#989278',
    '474M': '#989a82',
    '475M': '#625755',
    '476M': '#786b63',
    '477M': '#615f64',
    '478M': '#57545d',
    '479M': '#5c424b',
    '480M': '#4f4d40',
    '481M': '#8f548a',
    '482M': '#6e445c',
    '483M': '#6b867d',
    '484M': '#566f59',
    '485M': '#3c514c',
    '486M': '#678792',
    '487M': '#30658e',
    '488M': '#364064',
    '489M': '#b180ad',
    '490M': '#8e5874',
    '491M': '#aec5bf',
    '492M': '#a2b799',
    '493M': '#8ea497',
    '494M': '#809ea9',
    '495M': '#447698',
    '496M': '#566386',
    '497M': '#9b7d57',
    '498M': '#7e7459',
    '499M': '#554e83',
    '500M': '#827574',
    '501M': '#6c7c93',
    '502M': '#55657c',
    '503M': '#2b505d',
    '504M': '#4f4e4a',
    '505M': '#b8aa85',
    '506M': '#b4ab9a',
    '507M': '#7e77ad',
    '508M': '#978d8b',
    '509M': '#96a0ac',
    '510M': '#88969f',
    '511M': '#5f888c',
    '512M': '#757772',
    '513M': '#a98f44',
    '514M': '#422239',
    '515M': '#103929',
    '516M': '#111b23',
    '517M': '#394422',
    '518M': '#141533',
    '519M': '#471e26',
    '520M': '#365b31',
    '521M': '#1f2322',
    '522M': '#5e3322',
    '523M': '#1a474c',
    '524M': '#20224b',
    '525M': '#4b1925',
    '526M': '#052927',
    '527M': '#39172b',
    '528M': '#191e41',
    '529M': '#9a6b23',
    '530M': '#093363',
    '531M': '#3a281e',
    '532M': '#522319',
    '533M': '#406846',
    '534M': '#0b462d',
    '535M': '#1d1e5e',
    '536M': '#c3612a',
    '537M': '#9b5b1f',
    '538M': '#353a26',
    '539M': '#68272f',
    '540M': '#114d6c',
    '541M': '#6c2c2a',
    '542M': '#4b5030',
    '543M': '#794971',
    '544M': '#083e48',
    '545M': '#b25045',
    '546M': '#25317b',
    '547M': '#3f4322',
    '548M': '#3f2131',
    '549M': '#003438',
    '550M': '#383429',
    '551M': '#26396d',
    '552M': '#343031',
    '553M': '#a5744b',
    '554M': '#416330',
    '555M': '#412243',
    '556M': '#83392c',
    '557M': '#132043',
    '558M': '#3b3f21',
    '559M': '#11362f',
    '560M': '#5a303a',
    '561M': '#cc572a',
    '562M': '#31503e',
    '563M': '#feaa2f',
    '564M': '#483636',
    '565M': '#731635',
    '566M': '#1f4c31',
    '567M': '#a56b3b',
    '568M': '#1e263b',
    '569M': '#043633',
    '570M': '#c48f2f',
    '571M': '#38323e',
    '572M': '#57574b',
    '573M': '#633b3b',
    '574M': '#5f8046',
    '575M': '#232c65',
    '576M': '#f88d05',
    '577M': '#bd6e50',
    '578M': '#4e5124',
    '579M': '#786a2d',
    '580M': '#5f6b3b',
    '581M': '#3d2b2f',
    '582M': '#727a49',
    '583M': '#67523d',
    '584M': '#2a3c60',
    '585M': '#f46a4a',
    '586M': '#274a5d',
    '587M': '#274a5d',
    '588M': '#9c3e4e',
    '589M': '#23475d',
    '590M': '#695647',
    '591M': '#b58942',
    '592M': '#394a5a',
    '593M': '#9a683c',
    '594M': '#353628',
    '595M': '#5c3524',
    '596M': '#17212d',
    '597M': '#502e32',
    '598M': '#4c4415',
    '599M': '#2d2c2a',
    '600M': '#253833',
    '601M': '#6b6545',
    '602M': '#202736',
    '603M': '#5a4835',
    '604M': '#453141',
    '605M': '#38743e',
    '606M': '#162731',
    '607M': '#71583a',
    '608M': '#402e2c',
    '609M': '#e6af00',
    '610M': '#12544a',
    '611M': '#81743f',
    '612M': '#302835',
    '613M': '#6a6351',
    '614M': '#8e4260',
    '615M': '#7e633b',
    '616M': '#59363d',
    '617M': '#90372f',
    '618M': '#74a62a',
    '619M': '#383240',
    '620M': '#323641',
    '621M': '#3b2b2c',
    '622M': '#312d2c',
    '623M': '#a74850',
    '624M': '#382b45',
    '625M': '#961e28',
    '626M': '#645328',
    '627M': '#2b426e',
    '628M': '#422d34',
    '629M': '#532b4e',
    '630M': '#313c43',
    '631M': '#7d4f38',
    '632M': '#42404e',
    '633M': '#53534b',
    '634M': '#4b3441',
    '635M': '#703539',
    '636M': '#908865',
    '637M': '#2e292f',
    '638M': '#532031',
    '639M': '#6d5237',
    '640M': '#434831',
    '641M': '#394039',
    '642M': '#625149',
    '643M': '#4e5244',
    '644M': '#524348',
    '645M': '#873039',
    '646M': '#514422',
    '647M': '#1b2033',
    '648M': '#74611d',
    '649M': '#3a3d2a',
    '650M': '#2a3235',
    '651M': '#383637',
    '652M': '#7c6845',
    '653M': '#60664c',
    '654M': '#694e45',
    '655M': '#9e3057',
    '656M': '#43423d',
    '657M': '#5c353f',
    '658M': '#443435',
    '659M': '#192d46',
    '660M': '#1d594f',
    '661M': '#324941',
    '662M': '#484f47',
    '663M': '#58594b',
    '664M': '#224f93',
    '665M': '#32374d',
    '666M': '#32374d',
    '667M': '#94904a',
    '668M': '#2e4c64',
    '669M': '#523845',
    '670M': '#6d7985',
    '671M': '#a69067',
    '672M': '#b16488',
    '673M': '#8a7c57',
    '674M': '#666457',
    '675M': '#635234',
    '676M': '#454731',
    '677M': '#806a46',
    '678M': '#73454f',
    '679M': '#8e4652',
    '680M': '#93524c',
    '681M': '#693d4a',
    '682M': '#5d2f31',
    '683M': '#7b7c54',
    '684M': '#566956',
    '685M': '#454b31',
    '686M': '#4b5959',
    '687M': '#8c8558',
    '688M': '#4c2e36',
    '689M': '#614146',
    '690M': '#4f3d4d',
    '691M': '#463032',
    '692M': '#402f3f',
    '693M': '#86866e',
    '694M': '#8d826e',
    '695M': '#7c5655',
    '696M': '#664f49',
    '697M': '#3f3333',
    '698M': '#956049',
    '699M': '#5a4242',
    '700M': '#9e6744',
    '701M': '#6a413d',
    '702M': '#3e424d',
    '703M': '#5b756c',
    '704M': '#8e9672',
    '705M': '#24625d',
    '706M': '#49835d',
    '707M': '#24868f',
    '708M': '#88af56',
    '709M': '#304f7b',
    '710M': '#346d7e',
    '711M': '#454b7b',
    '712M': '#3e677d',
    '713M': '#6695ac',
    '714M': '#8188bc',
    '715M': '#64a9b8',
    '716M': '#5c8abc',
    '717M': '#d2ef95',
    '718M': '#39b5bf',
    '719M': '#6ea27e',
    '720M': '#447f79',
    '721M': '#8f966d',
    '722M': '#4e635a',
    '723M': '#95a2b3',
    '724M': '#e49b95',
    '725M': '#edba8b',
    '726M': '#9e7676',
    '727M': '#dea987',
    '728M': '#b6a19a',
    '729M': '#b3958a',
    '730M': '#a78583',
    '731M': '#a5957c',
    '732M': '#a1997f',
    '733M': '#9c86ac',
    '734M': '#a47e80',
    '735M': '#a588a4',
    '736M': '#b47c7f',
    '737M': '#805f69',
    '738M': '#d3cf88',
    '739M': '#6f8382',
    '740M': '#939e7d',
    '741M': '#7a9279',
    '742M': '#a9a872',
    '743M': '#da8f9e',
    '744M': '#cb80a9',
    '745M': '#e79892',
    '746M': '#dd859e',
    '747M': '#a97b85',
    '748M': '#d9c08a',
    '749M': '#aaaa84',
    '750M': '##bbaa7f',
    '751M': '#b2b193',
    '752M': '#bbab78',
    '753M': '#b5a262',
    '754M': '#c4b87e',
    '755M': '#865f38',
    '756M': '#8a6a44',
    '757M': '#6e5241',
    '758M': '#665e49',
    '759M': '#999275',
    '760M': '#4e4234',
    '761M': '#8f856a',
    '762M': '#413e2f',
    '763M': '#bdaa6f',
    '764M': '#d4bd94',
    '765M': '#685431',
    '766M': '#a58b5a',
    '767M': '#66583a',
    '768M': '#3b3c36',
    '769M': '#6d6f61',
    '770M': '#605e51',
    '771M': '#706957',
    '772M': '#6a5d3a',
    '773M': '#8e6273',
    '774M': '#a17282',
    '775M': '#692c56',
    '776M': '#aa648d',
    '777M': '#724945',
    '778M': '#381b25',
    '779M': '#5f3944',
    '780M': '#6f4849',
    '781M': '#7e5f5c',
    '782M': '#4b342e',
    '783M': '#524646',
    '784M': '#866961',
    '785M': '#553958',
    '786M': '#84597b',
    '787M': '#3f3b3c',
    '788M': '#3f3c57',
    '789M': '#4f4e5e',
    '790M': '#5a4250',
    '791M': '#6e5568',
    '792M': '#424348',
    '793M': '#647c5c',
    '794M': '#889e78',
    '795M': '#989468',
    '796M': '#8f8965',
    '797M': '#7a6a37',
    '798M': '#61605c',
    '799M': '#74716c',
    '800M': '#44584c',
    '801M': '#78857b',
    '802M': '#3f4d36',
    '803M': '#4b9692',
    '804M': '#72b7b2',
    '805M': '#285b54',
    '806M': '#64968b',
    '807M': '#638970',
    '808M': '#837d71',
    '809M': '#a8a594',
    '810M': '#7a7758',
    '811M': '#88886e',
    '812M': '#5d6443',
    '813M': '#5c7a7c',
    '814M': '#7a9390',
    '815M': '#6c7c6f',
    '816M': '#98a89d',
    '817M': '#767b5d',
    '818M': '#786060',
    '819M': '#917977',
    '820M': '#5f4e56',
    '821M': '#827678',
    '822M': '#7d6058',
    '823M': '#575d6b',
    '824M': '#aaacb9',
    '825M': '#aaacb9',
    '826M': '#c0c1b9',
    '827M': '#867b79',
    '828M': '#705e6a',
    '829M': '#a997a3',
    '830M': '#5a4d5e',
    '831M': '#84737e',
    '832M': '#786b72',
    '833M': '#977e56',
    '834M': '#c5ad7d',
    '835M': '#918052',
    '836M': '#a6996d',
    '837M': '#5a5432',
    '838M': '#9a7139',
    '839M': '#a68657',
    '840M': '#8e6144',
    '841M': '#835f45',
    '842M': '#533f27',
    '843M': '#6d6347',
    '844M': '#958a5d',
    '845M': '#7c5f35',
    '846M': '#8f7043',
    '847M': '#684e37',
    '848M': '#553e33',
    '849M': '#725c4f',
    '850M': '#5d3933',
    '851M': '#7b564d',
    '852M': '#5f3b2b',
    '853M': '#55524b',
    '854M': '#999683',
    '855M': '#445147',
    '856M': '#586555',
    '857M': '#3c4842',
    '858M': '#3d493f',
    '859M': '#7e887f',
    '860M': '#55554a',
    '861M': '#656658',
    '862M': '#534230',
    '863M': '#645451',
    '864M': '#aa9489',
    '865M': '#555549',
    '866M': '#949585',
    '867M': '#655546',
    '868M': '#353945',
    '869M': '#515560',
    '870M': '#342f2b',
    '871M': '#89877a',
    '872M': '#364250',
    '873M': '#91725d',
    '874M': '#b59475',
    '875M': '#6b5444',
    '876M': '#b9a082',
    '877M': '#453333',
    '878M': '#583c2e',
    '879M': '#897463',
    '880M': '#603d3b',
    '881M': '#92716c',
    '882M': '#6f636f',
    '883M': '#3b4954',
    '884M': '#7f8d96',
    '885M': '#474642',
    '886M': '#87897c',
    '887M': '#39434e',
    '888M': '#363f5e',
    '889M': '#5b6580',
    '890M': '#384862',
    '891M': '#556477',
    '892M': '#3a6c7d',
    '893M': '#294a69',
    '894M': '#5d8aab',
    '895M': '#694da1',
    '896M': '#a48bca',
    '897M': '#593043',
    '898M': '#30318b',
    '899M': '#5258ad',
    '900M': '#2677c8',
    '901M': '#609fd4',
    '902M': '#494f81',
    '903M': '#2d5ba6',
    '904M': '#5b8ecf',
    '905M': '#5861ad',
    '906M': '#6f77c0',
    '907M': '#27417a',
    '908M': '#664454',
    '909M': '#a87f8f',
    '910M': '#806b6a',
    '911M': '#aa9288',
    '912M': '#575789',
    '913M': '#d09115',
    '914M': '#4e1830',
    '915M': '#173e43',
    '916M': '#301921',
    '917M': '#0c4c6f',
    '918M': '#612c32',
    '919M': '#533638',
    '920M': '#242440',
    '921M': '#ad4742',
    '922M': '#205537',
    '923M': '#351a2c',
    '924M': '#0e2960',
    '925M': '#5a2532',
    '926M': '#19466a',
    '927M': '#6a6733',
    '928M': '#272729',
    '929M': '#82433a',
    '930M': '#124332',
    '931M': '#412732',
    '932M': '#033754',
    '933M': '#862b30',
    '934M': '#194136',
    '935M': '#222c45',
    '936M': '#5a2b3f',
    '937M': '#aa842f',
    '938M': '#422746',
    '939M': '#152968',
    '940M': '#91273b',
    '941M': '#2b432d',
    '942M': '#996024',
    '943M': '#255357',
    '944M': '#3e2f34',
    '945M': '#e28020',
    '946M': '#9a3c34',
    '947M': '#0b3835',
    '948M': '#261922',
    '949M': '#06295f',
    '950M': '#114447',
    '951M': '#52253f',
    '952M': '#52253f',
    '953M': '#a26e3b',
    '954M': '#96303d',
    '955M': '#3e2633',
    '956M': '#072122',
    '957M': '#401d3b',
    '958M': '#424827',
    '959M': '#4b322b',
    '960M': '#324553',
    '961M': '#6c3137',
    '962M': '#45224a',
    '963M': '#0d4d79',
    '964M': '#352a30',
    '965M': '#3e2a29',
    '966M': '#43212f',
    '967M': '#5b4a2d',
    '968M': '#2d2727',
    '969M': '#9b5e41',
    '970M': '#362c5e',
    '971M': '#71313f',
    '972M': '#204941',
    '973M': '#383637',
    '974M': '#224170',
    '975M': '#644e50',
    '976M': '#6c3e41',
    '977M': '#cc6b4a',
    '978M': '#853b65',
    '979M': '#685535',
    '980M': '#7c2a36',
    '981M': '#483620',
    '982M': '#963941',
    '983M': '#876639',
    '984M': '#423a2d',
    '985M': '#eaa385',
    '986M': '#75304c',
    '987M': '#c6b076',
    '988M': '#a3585f',
    '989M': '#775f46',
    '990M': '#c86069',
    '991M': '#a68e5e',
    '992M': '#6c5d4a',
    '993M': '#979559',
    '994M': '#c29d52',
    '995M': '#ae4458',
    '996M': '#a96b44',
    '997M': '#632966',
    '998M': '#1a3f38',
    '999M': '#434537',
    '1000M': '#422b31',
    '1001M': '#c0bc7f',
    '1002M': '#e0ca78',
    '1003M': '#e76d8a',
    '1004M': '#ddae80',
    '1005M': '#a15ba3',
    '1006M': '#4a756c',
    '1007M': '#909479',
    '1008M': '#774b5a',
    '1009M': '#e5cf49',
    '1010M': '#5c753b',
    '1011M': '#4043ad',
    '1012M': '#00749e',
    '1013M': '#4e343f',
    '1014M': '#1e4796',
    '1015M': '#3b5b5a',
    '1016M': '#63504a',
    '1017M': '#ded878',
    '1018M': '#9ab17b',
    '1019M': '#828ade',
    '1020M': '#08a9d7',
    '1021M': '#855d66',
    '1022M': '#6086d7',
    '1023M': '#769995',
    '1024M': '#7e6964',
    '1025M': '#c9887c',
    '1026M': '#68464d',
    '1027M': '#049791',
    '1028M': '#4e5e82',
    '1029M': '#41615c',
    '1030M': '#494b46',
    '1031M': '#285da6',
    '1032M': '#4e5f67',
    '1033M': '#cd9383',
    '1034M': '#90676f',
    '1035M': '#58c5be',
    '1036M': '#909bad',
    '1037M': '#909bad',
    '1038M': '#9ca091',
    '1039M': '#629bd2',
    '1040M': '#92a3aa',
    '1041M': '#f1a669',
    '1042M': '#95734f',
    '1043M': '#7e6546',
    '1044M': '#cf6d54',
    '1045M': '#82435e',
    '1046M': '#68435a',
    '1047M': '#7c3f66',
    '1048M': '#454545',
    '1049M': '#fcd599',
    '1050M': '#d9c389',
    '1051M': '#ab9a6d',
    '1052M': '#e88e76',
    '1053M': '#9e5d7b',
    '1054M': '#85556b',
    '1055M': '#9c5c81',
    '1056M': '#5a5955',
    '1057M': '#e8be6a',
    '1058M': '#bb855e',
    '1059M': '#cb8261',
    '1060M': '#c65747',
    '1061M': '#7d477c',
    '1062M': '#6d3f4a',
    '1063M': '#6f3855',
    '1064M': '#3d3c4e',
    '1065M': '#e0c580',
    '1066M': '#e0b884',
    '1067M': '#d7a281',
    '1068M': '#db8069',
    '1069M': '#7d4586',
    '1070M': '#744c54',
    '1071M': '#965678',
    '1072M': '#595866',
    '1073M': '#8f6d61',
    '1074M': '#73485c',
    '1075M': '#6a4d5f',
    '1076M': '#534a8b',
    '1077M': '#1ea48c',
    '1078M': '#375a42',
    '1079M': '#595d4c',
    '1080M': '#73754d',
    '1081M': '#c1a090',
    '1082M': '#b78198',
    '1083M': '#bea2ae',
    '1084M': '#807bbe',
    '1085M': '#53bfa8',
    '1086M': '#688f70',
    '1087M': '#999d79',
    '1088M': '#a8aa78',
    '1089M': '#a7786e',
    '1090M': '#ab5659',
    '1091M': '#91586b',
    '1092M': '#664d75',
    '1093M': '#6b9857',
    '1094M': '#37645f',
    '1095M': '#97a365',
    '1096M': '#336969',
    '1097M': '#dab49d',
    '1098M': '#e38d8b',
    '1099M': '#b88f9d',
    '1100M': '#bfa4cf',
    '1101M': '#bce0a0',
    '1102M': '#7eaca0',
    '1103M': '#dce4ad',
    '1104M': '#6cb5ae',
    '1105M': '#b09b6c',
    '1106M': '#5d464a',
    '1107M': '#66403f',
    '1108M': '#7c7b38',
    '1109M': '#253b50',
    '1110M': '#10626f',
    '1111M': '#353944',
    '1112M': '#393f4a',
    '1113M': '#bbb38c',
    '1114M': '#b0999b',
    '1115M': '#936664',
    '1116M': '#b3b262',
    '1117M': '#47677c',
    '1118M': '#21757c',
    '1119M': '#4a4a56',
    '1120M': '#535562',
    '1121M': '#8b735a',
    '1122M': '#786a5a',
    '1123M': '#554e55',
    '1124M': '#59654d',
    '1125M': '#00416f',
    '1126M': '#313d63',
    '1127M': '#296e84',
    '1128M': '#3b3f3e',
    '1129M': '#c5b09b',
    '1130M': '#c6b69b',
    '1131M': '#877b83',
    '1132M': '#a1ad90',
    '1133M': '#2b7b9e',
    '1134M': '#4e6391',
    '1135M': '#4d8a9c',
    '1136M': '#6b6f6e',
    '1137M': '#deac7f',
    '1138M': '#eae38b',
    '1139M': '#9d8968',
    '1140M': '#cecba3',
    '1141M': '#888e8a',
    '1142M': '#7b527c',
    '1143M': '#524964',
    '1144M': '#5c6a99',
    '1145M': '#fc9ba4',
    '1146M': '#d47772',
    '1147M': '#825774',
    '1148M': '#765864',
    '1149M': '#cfc592',
    '1150M': '#9ba17c',
    '1151M': '#5b7e7a',
    '1152M': '#636b68',
    '1153M': '#fcd8df',
    '1154M': '#ec687d',
    '1155M': '#db6971',
    '1156M': '#c075d1',
    '1157M': '#0db0b7',
    '1158M': '#95c86f',
    '1159M': '#288ca1',
    '1160M': '#6a7a4d',
    '1161M': '#e3df95',
    '1162M': '#f4d099',
    '1163M': '#fcb18a',
    '1164M': '#c56faa',
    '1165M': '#789ec7',
    '1166M': '#8085bd',
    '1167M': '#6bb0cf',
    '1168M': '#4e776d',
    '1169M': '#2b2d39',
    '1170M': '#5a3b41',
    '1171M': '#322b32',
    '1172M': '#362644',
    '1173M': '#2e2236',
    '1174M': '#272d39',
    '1175M': '#493359',
    '1176M': '#3c2b4f',
    '1177M': '#463154',
    '1178M': '#162f57',
    '1179M': '#622b28',
    '1180M': '#201f25',
    '1181M': '#1f2b29',
    '1182M': '#192c2a',
    '1183M': '#313c2b',
    '1184M': '#332124',
    '1185M': '#6c527f',
    '1186M': '#2f628d',
    '1187M': '#88483b',
    '1188M': '#503941',
    '1189M': '#3d4d42',
    '1190M': '#30554d',
    '1191M': '#576348',
    '1192M': '#533239',
    '1193M': '#645073',
    '1194M': '#4378a1',
    '1195M': '#b78169',
    '1196M': '#775563',
    '1197M': '#516258',
    '1198M': '#31574c',
    '1199M': '#636d53',
    '1200M': '#613942',
    '1201M': '#d9a34e',
    '1202M': '#d3a257',
    '1203M': '#3f3448',
    '1204M': '#514958',
    '1205M': '#486141',
    '1206M': '#546a43',
    '1207M': '#2c4152',
    '1208M': '#3d5863',
    '1209M': '#e0b96d',
    '1210M': '#e1d19d',
    '1211M': '#7a6d7f',
    '1212M': '#918a91',
    '1213M': '#99b181',
    '1214M': '#9ba37c',
    '1215M': '#5f818c',
    '1216M': '#5e7875',
    '1217M': '#4f4637',
    '1218M': '#827b64',
    '1219M': '#41495b',
    '1220M': '#5f6b85',
    '1221M': '#5a3943',
    '1222M': '#714353',
    '1223M': '#404654',
    '1224M': '#606871',
    '1225M': '#908875',
    '1226M': '#afb19a',
    '1227M': '#707988',
    '1228M': '#a6aab5',
    '1229M': '#ad838d',
    '1230M': '#c5a7a5',
    '1231M': '#828993',
    '1232M': '#9fa2a2',
    '1233M': '#d8d880',
    '1234M': '#dc9648',
    '1235M': '#b7835b',
    '1236M': '#bf634a',
    '1237M': '#955553',
    '1238M': '#8d4239',
    '1239M': '#7e4d8f',
    '1240M': '#62466c',
    '1241M': '#55373d',
    '1242M': '#5d4753',
    '1243M': '#89485e',
    '1244M': '#704b7f',
    '1245M': '#72486e',
    '1246M': '#673e50',
    '1247M': '#68418f',
    '1248M': '#506d4e',
    '1249M': '#6b6e43',
    '1250M': '#5e7c3e',
    '1251M': '#e1e8b5',
    '1252M': '#e5c383',
    '1253M': '#d0a473',
    '1254M': '#e78d6a',
    '1255M': '#db988f',
    '1256M': '#ab7e65',
    '1257M': '#8f5892',
    '1258M': '#7b5481',
    '1259M': '#754a53',
    '1260M': '#9f728c',
    '1261M': '#c36d92',
    '1262M': '#906ead',
    '1263M': '#8e6488',
    '1264M': '#bd8f99',
    '1265M': '#815ba1',
    '1266M': '#7e9a6f',
    '1267M': '#9b9f64',
    '1268M': '#91a371',
    '1269M': '#8d427a',
    '1270M': '#ac5370',
    '1271M': '#864b5a',
    '1272M': '#f2b949',
    '1273M': '#f69358',
    '1274M': '#c86b5c',
    '1275M': '#6b496c',
    '1276M': '#75456d',
    '1277M': '#7d465f',
    '1278M': '#0a7d84',
    '1279M': '#0a86a4',
    '1280M': '#038dc8',
    '1281M': '#8da74b',
    '1282M': '#abad48',
    '1283M': '#61824d',
    '1284M': '#657c50',
    '1285M': '#495aa2',
    '1286M': '#4d427c',
    '1287M': '#b773a6',
    '1288M': '#e091ac',
    '1289M': '#93646e',
    '1290M': '#fae18f',
    '1291M': '#ffcf94',
    '1292M': '#eaa683',
    '1293M': '#a588a7',
    '1294M': '#c183b6',
    '1295M': '#9d5e7d',
    '1296M': '#369a9c',
    '1297M': '#41a8b7',
    '1298M': '#3d9dc3',
    '1299M': '#bccc74',
    '1300M': '#cccd7d',
    '1301M': '#99b481',
    '1302M': '#96a97b',
    '1303M': '#7287d3',
    '1304M': '#8d81c9',
    '1305M': '#207290',
    '1306M': '#1f608a',
    '1307M': '#2f3363',
    '1308M': '#265082',
    '1309M': '#18484d',
    '1310M': '#356440',
    '1311M': '#749546',
    '1312M': '#42563b',
    '1313M': '#535432',
    '1314M': '#6b865b',
    '1315M': '#35604c',
    '1316M': '#294b44',
    '1317M': '#9d542c',
    '1318M': '#6a3336',
    '1319M': '#6f2f40',
    '1320M': '#76353b',
    '1321M': '#603840',
    '1322M': '#4d2828',
    '1323M': '#d77436',
    '1324M': '#d8a125',
    '1325M': '#a4822b',
    '1326M': '#b18025',
    '1327M': '#905d27',
    '1328M': '#544d3a',
    '1329M': '#433650',
    '1330M': '#513146',
    '1331M': '#512c34',
    '1332M': '#73435d',
    '1333M': '#83477d',
    '1334M': '#7d3880',
    '1335M': '#a83278',
    '1336M': '#732851',
    '1337M': '#3b3a63',
    '1338M': '#36404c',
    '1339M': '#564637',
    '1340M': '#483a39',
    '1341M': '#af8953',
    '1342M': '#a08a58',
    '1343M': '#95865b',
    '1344M': '#e9a34e',
    '1345M': '#755946',
    '1346M': '#b6753d',
    '1347M': '#e1c245',
    '1348M': '#b66f57',
    '1349M': '#9e4c7d',
    '1350M': '#35a984',
    '1351M': '#0faadb',
    '1352M': '#1f8791',
    '1353M': '#9e57c1',
    '1354M': '#4a517f',
    '1355M': '#55bf77',
    '1356M': '#416582',
    '1357M': '#535481',
    '1358M': '#5d7ba1',
    '1359M': '#d8bb81',
    '1360M': '#dbca99',
    '1361M': '#e7e0b2',
    '1362M': '#efc77d',
    '1363M': '#aa8f71',
    '1364M': '#fcd182',
    '1365M': '#d36fbf',
    '1366M': '#f471a3',
    '1367M': '#d56686',
    '1368M': '#84596a',
    '1369M': '#ad6e9b',
    '1370M': '#60535a',
    '1371M': '#c2835d',
    '1372M': '#accc67',
    '1373M': '#c0de7a',
    '1374M': '#7c7a65',
    '1375M': '#7d8685',
    '1376M': '#666e9b',
    '1377M': '#90986f',
    '1378M': '#714c77',
    '1379M': '#644a55',
    '1380M': '#344147',
    '1381M': '#514063',
    '1382M': '#885d4c',
    '1383M': '#a17457',
    '1384M': '#22545a',
    '1385M': '#4e403d',
    '1386M': '#6a988e',
    '1387M': '#a55e98',
    '1388M': '#1e736c',
    '1389M': '#256e88',
    '1390M': '#8f456a',
    '1391M': '#788a50',
    '1392M': '#6f444d',
    '1393M': '#402e4c',
    '1394M': '#633039',
    '1395M': '#be7b53',
    '1396M': '#7a9048',
    '1397M': '#c27b41',
    '1398M': '#3e6043',
    '1399M': '#9b832a',
    '1400M': '#283b5b',
    '1401M': '#175062',
    '1402M': '#203866',
    '1403M': '#25383e',
    '1404M': '#336aa3',
    '1405M': '#2f4e6a',
    '1406M': '#176f67',
    '1407M': '#1f577a',
    '1408M': '#a28f6f',
    '1409M': '#8c8161',
    '1410M': '#6b634c',
    '1411M': '#4d4636',
    '1412M': '#5b4d33',
    '1413M': '#f5bf00',
    '1414M': '#f9ac0f',
    '1415M': '#c99925',
    '1416M': '#d45534',
    '1417M': '#c74538',
    '1418M': '#812c4b',
    '1419M': '#662f34',
    '1420M': '#7a3336',
    '1421M': '#693d34',
    '1422M': '#a08e3c',
    '1423M': '#588e38',
    '1424M': '#1a543f',
    '1425M': '#40262f',
    '1426M': '#63262d',
    '1427M': '#4c2c31',
    '1428M': '#015e63',
    '1429M': '#1d5667',
    '1430M': '#3b4c39',
    '1431M': '#823d5a',
    '1432M': '#6f2b57',
    '1433M': '#643965',
    '1434M': '#37612f',
    '1435M': '#4e6026',
    '1436M': '#34472b',
    '1437M': '#7e3c67',
    '1438M': '#793d69',
    '1439M': '#4f3645',
    '1440M': '#15515b',
    '1441M': '#293752',
    '1442M': '#333649',
    '1443M': '#5b3e43',
    '1444M': '#673f47',
    '1445M': '#453746',
    '1446M': '#d29043',
    '1447M': '#b56146',
    '1448M': '#b7515e'

}



@loom_bp.route("/loom/<int:loom_id>/add_colors", methods=["GET", "POST"])
@login_required
def add_colors(loom_id):
    loom = Loom.query.get_or_404(loom_id)

    if request.method == "POST":
        border_color = request.form.get("border_color")
        body_color = request.form.get("body_color")

        new_color = WarpColor(
            loom_id=loom.id,
            border_color=border_color,
            body_color=body_color
        )
        db.session.add(new_color)
        db.session.commit()

        flash("Warp color details added successfully!", "success")
        return redirect(url_for("loom.materials", loom_id=loom.id))

    # ü©µ FIX HERE: add all_colors variable
    return render_template("add_colors.html", loom=loom, all_colors=ALL_COLORS)


@loom_bp.route('/loom/<int:loom_id>/add_weft', methods=['GET', 'POST'])
@login_required
def add_weft(loom_id):
    loom = Loom.query.get_or_404(loom_id)

    if request.method == 'POST':
        date = request.form.get('date')
        zari = request.form.get('zari')
        silk = request.form.get('silk')

        new_weft = Weft(
            loom_id=loom.id,
            date=datetime.strptime(date, "%Y-%m-%d"),
            zari=zari,
            silk=silk
        )

        db.session.add(new_weft)
        db.session.commit()

        flash('Weft details added successfully!', 'success')
        return redirect(url_for('loom.materials', loom_id=loom.id))

    return render_template("add_weft.html", loom=loom)


@loom_bp.route("/<int:loom_id>/view")
@login_required
def view_warp(loom_id):
    from app import db
    from models.loom import Loom, SareeEntry

    # Fetch the loom details
    loom = Loom.query.get_or_404(loom_id)

    # Fetch all warp entries related to this loom
    warp_entries = SareeEntry.query.filter_by(loom_id=loom_id, entry_type='warp').all()

    return render_template(
        "view_warp.html",
        loom=loom,
        warp_entries=warp_entries,
        loom_id=loom_id
    )




@loom_bp.route("/loom/<int:loom_id>/materials")
@login_required
def materials(loom_id):
    loom = Loom.query.filter_by(id=loom_id, user_id=current_user.id).first_or_404()
    warps = Warp.query.filter_by(loom_id=loom_id).all()
    wefts = Weft.query.filter_by(loom_id=loom.id).all()
    colors = WarpColor.query.filter_by(loom_id=loom.id).all()

    return render_template(
        "materials.html",
        loom=loom,
        warps=warps,
        wefts=wefts,
        colors=colors,
        all_colors=ALL_COLORS,  # ‚úÖ pass directly
    )



@loom_bp.route("/loom/<int:loom_id>/add_warp", methods=["GET", "POST"])
@login_required
def add_warp(loom_id):
    if request.method == "POST":
        zari_border_left = request.form.get("zari_border_left")
        zari_border_right = request.form.get("zari_border_right")
        zari_body = request.form.get("zari_body")
        silk_border_left = request.form.get("silk_border_left")
        silk_border_right = request.form.get("silk_border_right")
        silk_body = request.form.get("silk_body")

        # Save to database (example)
        new_warp = Warp(
            loom_id=loom_id,
            zari_border_left=zari_border_left,
            zari_border_right=zari_border_right,
            zari_body=zari_body,
            silk_border_left=silk_border_left,
            silk_border_right=silk_border_right,
            silk_body=silk_body,
        )
        db.session.add(new_warp)
        db.session.commit()

        # ‚úÖ Redirect to materials.html (your route for materials)
        return redirect(url_for('loom.materials', loom_id=loom_id))

    return render_template("add_warp.html", loom_id=loom_id)

# -------------------------------
# Helpers
# -------------------------------
def allowed_file(filename):
    ALLOWED_EXTENSIONS = {"png", "jpg", "jpeg", "gif", "pdf"}
    return "." in filename and filename.rsplit(".", 1)[1].lower() in ALLOWED_EXTENSIONS

def save_file(file):
    if file and file.filename and allowed_file(file.filename):
        filename = secure_filename(file.filename)
        timestamp = datetime.now().strftime("%Y%m%d_%H%M%S_")
        filename = timestamp + filename
        upload_folder = current_app.config.get("UPLOAD_FOLDER", "static/uploads")
        os.makedirs(upload_folder, exist_ok=True)
        file_path = os.path.join(upload_folder, filename)
        file.save(file_path)
        return filename
    return None

# -------------------------------
# Loom Routes
# -------------------------------
@loom_bp.route("/looms")
@login_required
def looms():
    looms = (
        Loom.query.filter_by(user_id=current_user.id)
        .order_by(Loom.created_at.desc())
        .all()
    )
    return render_template("looms.html", looms=looms)

@loom_bp.route("/create_loom", methods=["GET", "POST"])
@loom_bp.route("/create_loom/<int:weaver_id>", methods=["GET", "POST"])
@login_required
def create_loom(weaver_id=None):
    weaver = None
    weavers = []

    if weaver_id:
        weaver = Weaver.query.get_or_404(weaver_id)
    else:
        weavers = Weaver.query.filter_by(user_id=current_user.id, is_active=True).all()

    if request.method == "POST":
        try:
            loom_type = request.form.get("loom_type")
            saree_type = request.form.get("saree_type")
            saree_name = request.form.get("saree_name")
            weaver_name = request.form.get("weaver_name")
            num_sarees = int(request.form.get("num_sarees") or 0)

            last_loom = (
                Loom.query.filter_by(user_id=current_user.id)
                .order_by(Loom.loom_no.desc())
                .first()
            )
            next_loom_no = 1 if not last_loom else last_loom.loom_no + 1

            new_loom = Loom(
                loom_no=next_loom_no,
                user_id=current_user.id,
                loom_type=loom_type,
                num_sarees=num_sarees,
                saree_type=saree_type,
                saree_name=saree_name,
                weaver_name=weaver_name if weaver_name else "No Weaver",
                created_at=datetime.utcnow(),
                updated_at=datetime.utcnow(),
            )

            db.session.add(new_loom)
            db.session.commit()
            flash("Loom created successfully!", "success")
            return redirect(url_for("loom.looms"))

        except Exception as e:
            db.session.rollback()
            flash(f"Failed to create loom: {e}", "danger")

    return render_template("create_loom.html", weaver=weaver, weavers=weavers)

@loom_bp.route("/<int:loom_id>")
@login_required
def view_loom(loom_id):
    loom = Loom.query.filter_by(id=loom_id, user_id=current_user.id).first_or_404()
    sarees = (
        SareeEntry.query.filter_by(loom_id=loom.id)
        .order_by(SareeEntry.saree_number)
        .all()
    )

    # Attach readable color info correctly (fixed indentation)
    for s in sarees:
        # Border color
        if s.border_color in ALL_COLORS:
            s.border_hex = ALL_COLORS[s.border_color]
        else:
            s.border_hex = "#ffffff"  # fallback

        # Body color
        if s.body_color in ALL_COLORS:
            s.body_hex = ALL_COLORS[s.body_color]
        else:
            s.body_hex = "#ffffff"

    return render_template("view_loom.html", loom=loom, sarees=sarees, all_colors=ALL_COLORS)

@loom_bp.route("/edit_loom/<int:loom_id>", methods=["GET", "POST"])
@login_required
def edit_loom(loom_id):
    loom = Loom.query.filter_by(id=loom_id, user_id=current_user.id).first_or_404()
    weavers = Weaver.query.filter_by(user_id=current_user.id, is_active=True).all()

    if request.method == "POST":
        try:
            loom.saree_name = request.form.get("saree_name")
            loom.amount_credit = float(request.form.get("amount_credit") or 0)
            loom.amount_debit = float(request.form.get("amount_debit") or 0)
            loom.num_sarees = int(request.form.get("num_sarees") or loom.num_sarees)

            weaver_id = request.form.get("weaver_id")
            loom.weaver_id = weaver_id if weaver_id else None

            file = request.files.get("saree_image")
            filename = save_file(file)
            if filename:
                loom.saree_image = filename

            loom.updated_at = datetime.utcnow()
            db.session.commit()
            flash("Loom updated successfully!", "success")
            return redirect(url_for("loom.view_loom", loom_id=loom.id))

        except Exception as e:
            db.session.rollback()
            flash(f"Failed to update loom: {e}", "danger")

    return render_template("edit_loom.html", loom=loom, weavers=weavers)

@loom_bp.route("/delete_loom/<int:loom_id>", methods=["POST"])
@login_required
def delete_loom(loom_id):
    loom = Loom.query.filter_by(id=loom_id, user_id=current_user.id).first_or_404()
    try:
        db.session.delete(loom)
        db.session.commit()
        flash("Loom deleted successfully!", "success")
    except Exception as e:
        db.session.rollback()
        flash(f"Failed to delete loom: {e}", "danger")

    return redirect(url_for("loom.looms"))

# -------------------------------
# Saree Entry Routes
# -------------------------------
@loom_bp.route("/<int:loom_id>/add_saree", methods=["GET", "POST"])
@login_required
def add_saree(loom_id):
    loom = Loom.query.filter_by(id=loom_id, user_id=current_user.id).first_or_404()

    if request.method == "POST":
        try:
            # ---------------------- Parse Dates ---------------------- #
            date_str = request.form.get("date")
            saree_date = datetime.strptime(date_str, "%Y-%m-%d").date() if date_str else None

            completion_date_str = request.form.get("completion_date")
            completion_date = datetime.strptime(completion_date_str, "%Y-%m-%d").date() if completion_date_str else None

            # ---------------------- Limit Check ---------------------- #
            existing_count = SareeEntry.query.filter_by(loom_id=loom.id).count()
            if loom.num_sarees and existing_count >= loom.num_sarees:
                flash("You cannot add more sarees. Limit reached.", "danger")
                return redirect(url_for("loom.view_loom", loom_id=loom.id))

            # ---------------------- Auto Saree Number ---------------------- #
            last_saree_number = db.session.query(func.max(SareeEntry.saree_number)) \
                .filter_by(loom_id=loom.id).scalar()
            saree_number = (last_saree_number or 0) + 1

            # ---------------------- Create Saree Entry ---------------------- #
            saree = SareeEntry(
                loom_id=loom.id,
                saree_number=saree_number,
                saree_name=request.form.get("saree_name"),
                border_color=request.form.get("border_color"),
                body_color=request.form.get("body_color"),

                # ‚úÖ Meena Colors (Names + HEX)
                meena_a=request.form.get("meena_a"),
                meena_a_hex=request.form.get("meena_a_hex"),
                meena_b=request.form.get("meena_b"),
                meena_b_hex=request.form.get("meena_b_hex"),
                meena_c=request.form.get("meena_c"),
                meena_c_hex=request.form.get("meena_c_hex"),
                meena_d=request.form.get("meena_d"),
                meena_d_hex=request.form.get("meena_d_hex"),

                # ‚úÖ Other details
                warp_weft=request.form.get("warp_weft"),
                material=request.form.get("material"),
                amount_credit=float(request.form.get("amount_credit") or 0),
                amount_debit=float(request.form.get("amount_debit") or 0),
                date=saree_date,
                completion_date=completion_date
            )

            # ---------------------- Handle File Upload ---------------------- #
            file = request.files.get("saree_image")
            filename = save_file(file)
            if filename:
                saree.saree_image = filename

            # ---------------------- Save to Database ---------------------- #
            db.session.add(saree)
            db.session.commit()

            flash("‚úÖ New saree added successfully!", "success")
            return redirect(url_for("loom.view_loom", loom_id=loom.id))

        except Exception as e:
            db.session.rollback()
            flash(f"‚ö†Ô∏è Failed to add saree: {e}", "danger")

    # ---------------------- Render Template ---------------------- #
    return render_template(
        "add_saree.html",
        loom=loom,
        loom_id=loom_id,
        all_colors=ALL_COLORS
    )

@loom_bp.route("/<int:loom_id>/edit_saree/<int:saree_id>", methods=["GET", "POST"])
@login_required
def edit_saree(loom_id, saree_id):
    saree = SareeEntry.query.filter_by(id=saree_id, loom_id=loom_id).first_or_404()
    loom = Loom.query.get_or_404(loom_id)

    if request.method == "POST":
        try:
            # Dates
            date_str = request.form.get("date")
            saree.date = datetime.strptime(date_str, "%Y-%m-%d").date() if date_str else saree.date

            completion_date_str = request.form.get("completion_date")
            saree.completion_date = datetime.strptime(completion_date_str, "%Y-%m-%d").date() if completion_date_str else saree.completion_date

            # Basic fields
            saree.saree_name = request.form.get("saree_name")
            saree.border_color = request.form.get("border_color")
            saree.body_color = request.form.get("body_color")
            saree.warp_weft = request.form.get("warp_weft")
            saree.material = request.form.get("material")
            saree.amount_credit = float(request.form.get("amount_credit") or 0)
            saree.amount_debit = float(request.form.get("amount_debit") or 0)

            # Image update
            file = request.files.get("saree_image")
            filename = save_file(file)
            if filename:
                saree.saree_image = filename

            db.session.commit()
            flash("Saree updated successfully!", "success")
            return redirect(url_for("loom.view_loom", loom_id=loom_id))

        except Exception as e:
            db.session.rollback()
            flash(f"Failed to update saree: {e}", "danger")

    return render_template("edit_saree.html", saree=saree, loom=loom, loom_id=loom_id, all_colors=ALL_COLORS)


# -------------------------------
# Weaver Assignment Routes
# -------------------------------
@loom_bp.route("/assign_weaver/<int:loom_id>/<int:weaver_id>", methods=["POST"])
@login_required
def assign_weaver(loom_id, weaver_id):
    loom = Loom.query.filter_by(id=loom_id, user_id=current_user.id).first_or_404()
    weaver = Weaver.query.filter_by(id=weaver_id, user_id=current_user.id).first_or_404()

    try:
        loom.weaver_id = weaver.id
        db.session.commit()
        flash(f'Loom "{loom.saree_name}" assigned to weaver "{weaver.weavername}".', "success")
    except Exception as e:
        db.session.rollback()
        flash(f"Failed to assign weaver: {e}", "danger")

    return redirect(url_for("loom.view_loom", loom_id=loom_id))

@loom_bp.route("/unassign_weaver/<int:loom_id>", methods=["POST"])
@login_required
def unassign_weaver(loom_id):
    loom = Loom.query.filter_by(id=loom_id, user_id=current_user.id).first_or_404()
    try:
        loom.weaver_id = None
        db.session.commit()
        flash(f'Weaver unassigned from loom "{loom.saree_name}".', "success")
    except Exception as e:
        db.session.rollback()
        flash(f"Failed to unassign weaver: {e}", "danger")

    return redirect(url_for("loom.view_loom", loom_id=loom_id))

# -------------------------------
# Download Route (CSV Export)
# -------------------------------
@loom_bp.route('/<int:loom_id>/download')
@login_required
def download(loom_id):
    loom = Loom.query.get_or_404(loom_id)
    sarees = (
        SareeEntry.query.filter_by(loom_id=loom.id)
        .order_by(SareeEntry.saree_number)
        .all()
    )

    output = io.StringIO()
    output.write("Saree No,Date,Completion Date,Name,Color,Warp/Weft,Material,Credit,Debit,Balance\n")
    for s in sarees:
        color_value = ALL_COLORS.get(s.colors, s.colors or "")
        output.write(
            f"{s.saree_number},{s.date or ''},{s.completion_date or ''},{s.saree_name or ''},"
            f"{s.colors or ''} ({color_value}),{s.warp_weft or ''},{s.material or ''},"
            f"{s.amount_credit or 0},{s.amount_debit or 0},{s.balance or 0}\n"
        )

    mem = io.BytesIO()
    mem.write(output.getvalue().encode('utf-8'))
    mem.seek(0)

    return send_file(
        mem,
        as_attachment=True,
        download_name=f"loom_{loom_id}.csv",
        mimetype="text/csv"
    )